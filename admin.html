<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IMPACTA ADMIN CONSOLE</title>
  <link rel="icon" type="image/x-icon" href="img/logo-mobile-2025">
  <link rel="icon" href="img/favicon-2025.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* --- STRATEGIC STYLING --- */
    :root{
      --brand:#0c62ab; --brand-dark:#094a80; --ink:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --bg:#f8fafc; --radius:12px;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    
    body{ margin:0; font-family:var(--sans); color:var(--ink); background: var(--bg); line-height:1.5; font-size: 14px; }
    
    /* UTILITIES */
    .wrap{max-width:1600px; margin:0 auto; padding:0 24px}
    .flex{display:flex; align-items:center; gap:12px}
    .col{flex-direction:column; align-items:flex-start}
    
    /* TOPBAR */
    .topbar{ position:sticky; top:0; z-index:50; border-bottom:1px solid var(--line); background:#fff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .topbar .inner{ padding:14px 0; display:flex; justify-content:space-between; align-items:center; }
    .brand h1 { margin:0; font-size:20px; font-weight:800; color:var(--brand); letter-spacing: -0.02em; }
    .brand p { margin:0; font-size:11px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:0.05em;}
    
    /* BUTTONS */
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 16px; border-radius:8px; border:1px solid transparent; background:var(--brand); color:#fff; font-weight:600; font-size:13px; cursor:pointer; transition:all .15s ease; }
    .btn:hover{background:var(--brand-dark)}
    .btn.secondary{background:#fff; color:var(--ink); border:1px solid var(--line);}
    .btn.secondary:hover{background:#f1f5f9; border-color:#cbd5e1}
    .btn.danger{background:#fff; color:#b91c1c; border:1px solid #fecaca;}
    .btn.danger:hover{background:#fef2f2; border-color:#b91c1c}

    /* CARDS */
    .card{ background:#fff; border:1px solid var(--line); border-radius:var(--radius); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); overflow:hidden; margin-bottom:24px; }
    .card .hd{ padding:16px 24px; border-bottom:1px solid var(--line); background:#f8fafc; display:flex; justify-content:space-between; align-items:center; }
    .card .hd h2{ margin:0; font-size:16px; font-weight:700; color:var(--ink); }
    .card .bd{ padding:24px; }

    /* FILTERS */
    .filter-bar { display:grid; grid-template-columns: repeat(5, 1fr) auto; gap:10px; margin-bottom:16px; padding:16px; background:#f8fafc; border:1px solid var(--line); border-radius:8px; align-items:end; }
    .filter-group label { display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:4px; text-transform:uppercase; }
    select, input { width:100%; padding:8px 12px; border-radius:6px; border:1px solid var(--line); font-size:13px; background:#fff; color:var(--ink); outline:none; }
    select:focus, input:focus { border-color:var(--brand); ring:2px var(--brand); }

    .filters { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; background:#f1f5f9; padding:16px; border-radius:8px; border:1px solid var(--line); margin-bottom:20px; }

    /* TABLES */
    .tablewrap{ width:100%; overflow-x:auto; border:1px solid var(--line); border-radius:8px; }
    table{ width:100%; border-collapse:collapse; background:#fff; }
    th, td{ padding:12px 16px; border-bottom:1px solid var(--line); text-align:left; font-size:13px; vertical-align:top; }
    th{ background:#f8fafc; font-weight:700; color:var(--muted); text-transform:uppercase; font-size:11px; white-space:nowrap; position:sticky; top:0; z-index:10; cursor:pointer;}
    th:hover { color:var(--brand); }
    tr:last-child td { border-bottom:none; }
    tr:hover td { background:#f8fafc; }
    
    .status-pill { display:inline-block; padding:2px 8px; border-radius:12px; font-size:11px; font-weight:700; text-transform:uppercase; background:#e0f2fe; color:#0369a1; }
    .badge { padding:2px 8px; border-radius:99px; font-size:11px; font-weight:700; background:#e2e8f0; }
    .badge.admin { background:#dbeafe; color:#1e40af; }
    input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }

    /* REPORT TABLE SPECIFICS */
    .report-cell { text-align: center; font-variant-numeric: tabular-nums; }
    .report-total { font-weight: 800; color: var(--brand); background: #f1f5f9; text-align: center; }
    .report-day-header { text-align: center; min-width: 30px; }

    /* MODAL */
    .modal { position:fixed; inset:0; background:rgba(15,23,42,.7); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; padding:20px; z-index:1000; }
    .modal.open { display:flex; }
    .modal .panel { width:min(500px, 95%); background:#fff; border-radius:12px; border:1px solid var(--line); overflow:hidden; display:flex; flex-direction:column; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); }
    .modal .hd { padding:16px 24px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; background:#fff; }
    .modal .bd { padding:24px; }
    textarea.import-area { width:100%; height:200px; padding:12px; border:1px solid var(--line); border-radius:8px; font-family:var(--sans); font-size:13px; resize:vertical; outline:none; background:#f8fafc; }

    .loading { color:var(--muted); font-style:italic; padding:20px; text-align:center; }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="wrap">
      <div class="inner">
        <div class="brand">
          <h1>IMPACTA ADMIN</h1>
          <p>Strategic Revenue Console</p>
        </div>
        <div class="flex">
          <span id="adminUser" style="font-size:12px; color:var(--muted); font-weight:600;"></span>
          <a href="crm.html" class="btn secondary">Open CRM</a>
          <button class="btn secondary" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap" style="padding-top:30px;">
    
    <section class="card">
        <div class="hd">
            <div class="flex col" style="gap:2px;">
                <h2>Monthly Call Performance</h2>
                <span style="font-size:12px; color:var(--muted);">Total calls/activities per agent per day.</span>
            </div>
            <div class="flex">
                <select id="rep_month" style="width:auto;"></select>
                <select id="rep_year" style="width:auto;"></select>
                <button class="btn" onclick="generateReport()">Generate Report</button>
            </div>
        </div>
        <div class="bd">
            <div class="tablewrap" style="max-height:500px; overflow:auto;">
                <table id="reportTable">
                    <thead><tr id="reportHeadRow"><th>Agent</th><th>Total</th></tr></thead>
                    <tbody id="reportBody"><tr><td colspan="5" class="loading">Select a date and click Generate.</td></tr></tbody>
                </table>
            </div>
        </div>
    </section>

    <section class="card">
      <div class="hd">
        <div class="flex col" style="gap:2px;">
          <h2>Global Activity History</h2>
          <span style="font-size:12px; color:var(--muted);">Real-time monitoring of all agent interactions.</span>
        </div>
        <div><button class="btn" onclick="fetchHistory()">ðŸ”„ Refresh Data</button></div>
      </div>
      <div class="bd">
        <div class="filters">
            <div class="filter-group" style="flex:1;">
                <label>Agent / Caller</label>
                <select id="h_caller"><option value="all">All Agents</option></select>
            </div>
            <div class="filter-group"><label>Year</label><select id="h_year"></select></div>
            <div class="filter-group"><label>Month</label><select id="h_month"></select></div>
            <div class="filter-group"><label>Day</label><select id="h_day"></select></div>
            <div class="filter-group">
                <button class="btn secondary" onclick="setToToday()">Reset to Today</button>
            </div>
        </div>
        <div class="tablewrap" style="max-height:400px; overflow-y:auto;">
          <table id="historyTable">
            <thead>
              <tr>
                <th style="width:160px;">Timestamp</th>
                <th style="width:150px;">Agent</th>
                <th style="width:200px;">Lead / Company</th>
                <th style="width:150px;">Action</th>
                <th>Notes / Outcome</th>
              </tr>
            </thead>
            <tbody id="historyBody"><tr><td colspan="5" class="loading">Loading History...</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card">
        <div class="hd">
        <h2>Lead Database</h2>
        <div class="flex">
            <button class="btn secondary" onclick="exportAllData()">â¬‡ Export Leads & History</button>
            <button class="btn secondary" onclick="openImportModal()">Import CSV</button>
        </div>
        </div>
      <div class="bd">
         
        <div class="filter-bar">
            <div class="filter-group">
                <label>Status</label>
                <select id="f_stage" onchange="applyFilters()"><option value="">All</option></select>
            </div>
            <div class="filter-group">
                <label>City</label>
                <select id="f_city" onchange="applyFilters()"><option value="">All</option></select>
            </div>
            <div class="filter-group">
                <label>State</label>
                <select id="f_state" onchange="applyFilters()"><option value="">All</option></select>
            </div>
            <div class="filter-group">
                <label>Industry</label>
                <select id="f_industry" onchange="applyFilters()"><option value="">All</option></select>
            </div>
            <div class="filter-group">
                <label>Assigned To</label>
                <select id="f_assign" onchange="applyFilters()"><option value="unassigned">Unassigned</option></select>
            </div>
            <div>
                <button class="btn secondary" style="width:100%" onclick="resetFilters()">Reset</button>
            </div>
        </div>

        <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; padding:10px; background:#f1f5f9; border-radius:6px; border:1px solid var(--line);">
            <span style="font-size:13px; font-weight:600; color:var(--ink);">Bulk Actions:</span>
            <select id="assignUser" style="width:200px; padding:8px;"><option value="">Select Agent...</option></select>
            <button class="btn" style="padding:8px 16px;" onclick="assignLeads()">Assign</button>
            <button class="btn secondary" style="padding:8px 16px;" onclick="bulkUnassign()">Unassign Selected</button>
            <button class="btn danger" style="padding:8px 16px; margin-left:8px;" onclick="bulkDelete()">Delete Selected</button>
            
            <span id="recordCount" style="margin-left:auto; font-size:12px; color:#64748b; font-weight:600;">0 records</span>
        </div>

         <div class="tablewrap" style="max-height:600px; overflow-y:auto; border:1px solid var(--line);">
            <table>
                <thead>
                    <tr>
                        <th style="width:40px; text-align:center;"><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
                        <th onclick="setSort('company')">Company</th>
                        <th onclick="setSort('cityClean')">City</th>
                        <th onclick="setSort('stateExtracted')">State</th>
                        <th onclick="setSort('industry')">Industry</th>
                        <th onclick="setSort('assignedName')">Assigned To</th>
                        <th onclick="setSort('stage')">Stage</th>
                        <th style="text-align:right">Actions</th>
                    </tr>
                </thead>
                <tbody id="leadList">
                    <tr><td colspan="8" class="loading">Loading Leads...</td></tr>
                </tbody>
            </table>
         </div>
      </div>
    </section>

    <section class="card">
        <div class="hd">
            <div class="flex col" style="gap:2px;">
                <h2>Personnel & Access Control</h2>
                <span style="font-size:12px; color:var(--muted);">Manage authorized agents and credentials.</span>
            </div>
        </div>
        <div class="bd">
            <div class="filters" style="display:grid; grid-template-columns: 2fr 2fr 2fr 1fr 1fr; gap:12px;">
                <div class="filter-group"><label>Full Name</label><input id="newUserName" placeholder="e.g. John Doe"></div>
                <div class="filter-group"><label>Email</label><input id="newUserEmail" type="email" placeholder="agent@impacta.com"></div>
                <div class="filter-group"><label>Password</label><input id="newUserPass" type="text" placeholder="Min 6 chars"></div>
                <div class="filter-group">
                    <label>Role</label>
                    <select id="newUserRole"><option value="agent">Agent</option><option value="admin">Admin</option></select>
                </div>
                <div><button class="btn" style="width:100%" onclick="createUser()">+ Create User</button></div>
            </div>
            <div class="tablewrap" style="margin-top:20px;">
                <table>
                    <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Created</th><th style="text-align:right">Actions</th></tr></thead>
                    <tbody id="userList"><tr><td colspan="5" class="loading">Loading Personnel...</td></tr></tbody>
                </table>
            </div>
        </div>
    </section>

  </main>

    <div class="modal" id="editUserModal">
        <div class="panel">
        <div class="hd"><h3>Edit Personnel</h3><button class="btn secondary" onclick="closeModal('editUserModal')">&times;</button></div>
        <div class="bd">
            <input type="hidden" id="editUserId">
            <input type="hidden" id="editUserOldEmail"> <div class="filter-group" style="margin-bottom:12px;">
                <label>Full Name</label>
                <input id="editUserNameField" style="width:100%" placeholder="Agent Name">
            </div>
            
            <div class="filter-group" style="margin-bottom:16px;">
                <label>Sign-In Email</label>
                <input id="editUserEmailField" type="email" style="width:100%" placeholder="agent@impacta.cloud">
            </div>
            
            <button class="btn" style="width:100%" onclick="saveUserEdit()">Save Changes</button>
        </div>
        </div>
    </div>

  <div class="modal" id="importModal">
    <div class="panel">
      <div class="hd"><h3>Import Leads (CSV)</h3><button class="btn secondary" onclick="closeModal('importModal')">&times;</button></div>
      <div class="bd">
        <p style="font-size:13px; color:var(--muted); margin-top:0;">Headers required: Company, Phone, City, State, Industry, Recommendation, etc.</p>
        <textarea id="importText" class="import-area" placeholder="Company,Phone,City,State..."></textarea>
        <button class="btn" style="width:100%; margin-top:12px;" onclick="processImport()">Process Import</button>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAd6SXuX3nNzoCr07ENc-u_QRU1Not_FAI",
    authDomain: "impactacrm.firebaseapp.com",
    projectId: "impactacrm",
    storageBucket: "impactacrm.firebasestorage.app",
    messagingSenderId: "323514822260",
    appId: "1:323514822260:web:9eec9a85f865abb780ab21",
    measurementId: "G-DW3JFMDG6Y"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let userMap = {}; 
  let allLeads = [];
  let filteredLeads = [];
  let allUsers = [];
  let sortKey = 'createdAt'; 
  let sortDesc = true;

  function init() {
    auth.onAuthStateChanged(user => {
        if(!user) return window.location.href = 'index.html';
        
        db.collection('users').doc(user.uid).get().then(doc => {
            const role = doc.exists ? doc.data().role : 'agent';
            if(role !== 'admin') {
                alert("Access Denied: Strategic Oversight Clearance Required.");
                window.location.href = 'crm.html';
                return;
            }
            document.getElementById('adminUser').textContent = `Admin: ${user.email}`;
            populateDateFilters();
            listenToUsers(); 
            fetchHistory(); 
            listenToLeads(); 
        });
    });

    ['h_year', 'h_month', 'h_day', 'h_caller'].forEach(id => {
        document.getElementById(id).addEventListener('change', fetchHistory);
    });
  }

  function populateDateFilters() {
    const today = new Date();
    const curYear = today.getFullYear();
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    // Populate Report Filters
    const repMonth = document.getElementById('rep_month');
    const repYear = document.getElementById('rep_year');
    months.forEach((m, i) => repMonth.add(new Option(m, i, i === today.getMonth(), i === today.getMonth())));
    for(let y = curYear - 1; y <= curYear + 1; y++) repYear.add(new Option(y, y, y === curYear, y === curYear));

    // Populate History Filters
    const selYear = document.getElementById('h_year');
    const selMonth = document.getElementById('h_month');
    const selDay = document.getElementById('h_day');

    for(let y = curYear - 2; y <= curYear + 1; y++) selYear.add(new Option(y, y, y === curYear, y === curYear));
    months.forEach((m, i) => selMonth.add(new Option(m, i, i === today.getMonth(), i === today.getMonth())));
    for(let d=1; d<=31; d++) selDay.add(new Option(d, d, d === today.getDate(), d === today.getDate()));
  }

  function setToToday() {
      const today = new Date();
      document.getElementById('h_year').value = today.getFullYear();
      document.getElementById('h_month').value = today.getMonth();
      document.getElementById('h_day').value = today.getDate();
      document.getElementById('h_caller').value = 'all';
      fetchHistory();
  }

  function listenToUsers() {
      db.collection('users').onSnapshot(snap => {
          allUsers = [];
          const sel = document.getElementById('h_caller');
          const assignSel = document.getElementById('assignUser');
          const tbody = document.getElementById('userList');
          
          sel.innerHTML = '<option value="all">All Agents</option>';
          assignSel.innerHTML = '<option value="">Select Agent...</option>';
          tbody.innerHTML = '';

          snap.forEach(doc => {
              const d = doc.data();
              d.id = doc.id;
              allUsers.push(d);
              userMap[doc.id] = d;

              let name = d.name || d.email;
              sel.add(new Option(name, doc.id));
              
              if(d.role === 'agent') {
                  assignSel.add(new Option(name, doc.id));
              }

              const created = d.createdAt ? new Date(d.createdAt.toDate()).toLocaleDateString() : '-';
              const badgeClass = d.role === 'admin' ? 'badge admin' : 'badge';
              
              tbody.innerHTML += `
                <tr>
                    <td style="font-weight:600">${name}</td>
                    <td>${d.email}</td>
                    <td><span class="${badgeClass}">${d.role}</span></td>
                    <td style="color:var(--muted); font-size:12px;">${created}</td>
                    <td style="text-align:right">
                        <button class="btn secondary" style="padding:4px 8px; font-size:11px;" onclick="sendPasswordReset('${d.email}')">Reset Pass</button>
                        <button class="btn secondary" style="padding:4px 8px; font-size:11px;" onclick="openEditUser('${doc.id}')">Edit</button>
                        <button class="btn danger" style="padding:4px 8px; font-size:11px;" onclick="deleteUser('${doc.id}')">Remove</button>
                    </td>
                </tr>`;
          });
          
          if(allLeads.length > 0) populateLeadFilterOptions();
      });
  }

  // --- REPORT LOGIC ---
  async function generateReport() {
      const m = parseInt(document.getElementById('rep_month').value);
      const y = parseInt(document.getElementById('rep_year').value);
      const headRow = document.getElementById('reportHeadRow');
      const tbody = document.getElementById('reportBody');
      
      tbody.innerHTML = '<tr><td colspan="35" class="loading">Analyzing Call Data...</td></tr>';

      // 1. Determine days in month
      const daysInMonth = new Date(y, m + 1, 0).getDate();
      
      // 2. Build Headers
      let headerHTML = '<th>Agent</th>';
      for(let d=1; d<=daysInMonth; d++) {
          headerHTML += `<th class="report-day-header">${d}</th>`;
      }
      headerHTML += '<th>Total</th>';
      headRow.innerHTML = headerHTML;

      // 3. Fetch Data
      const start = new Date(y, m, 1);
      const end = new Date(y, m + 1, 0, 23, 59, 59);
      
      try {
          const snap = await db.collectionGroup('activities')
              .where('createdAt', '>=', start)
              .where('createdAt', '<=', end)
              .get();
          
          // 4. Initialize Stats Bucket: { userId: { day: count, total: count } }
          const stats = {};
          
          // Pre-fill active agents so they show up even with 0 calls
          allUsers.forEach(u => {
             if(u.role !== 'admin') { // Only show agents usually, or check all
                 stats[u.id] = { name: u.name || u.email, total: 0, days: new Array(daysInMonth + 1).fill(0) };
             }
          });

          // 5. Aggregate
          snap.forEach(doc => {
              const d = doc.data();
              const uid = d.createdBy;
              
              // If user deleted or not in list, fallback
              if(!stats[uid]) {
                   // Try to find name in userMap, else 'Unknown'
                   const name = userMap[uid] ? (userMap[uid].name || userMap[uid].email) : 'Unknown Agent';
                   stats[uid] = { name: name, total: 0, days: new Array(daysInMonth + 1).fill(0) };
              }

              const date = d.createdAt.toDate();
              const day = date.getDate();
              
              stats[uid].days[day]++;
              stats[uid].total++;
          });

          // 6. Render Rows
          let html = '';
          Object.values(stats).forEach(agent => {
              html += `<tr><td style="font-weight:600; color:var(--brand-dark); white-space:nowrap;">${agent.name}</td>`;
              for(let d=1; d<=daysInMonth; d++) {
                  const count = agent.days[d];
                  const style = count > 0 ? 'font-weight:700; color:#0f172a;' : 'color:#cbd5e1;';
                  html += `<td class="report-cell" style="${style}">${count > 0 ? count : '-'}</td>`;
              }
              html += `<td class="report-total">${agent.total}</td></tr>`;
          });
          
          if(html === '') html = '<tr><td colspan="35" style="padding:20px; text-align:center;">No activity found for this month.</td></tr>';
          tbody.innerHTML = html;

      } catch(e) {
          console.error(e);
          tbody.innerHTML = `<tr><td colspan="35" style="color:red">Error: ${e.message}</td></tr>`;
      }
  }

  function listenToLeads() {
      db.collection('leads').onSnapshot(snap => {
          allLeads = [];
          snap.forEach(doc => {
              let l = doc.data();
              l.id = doc.id;
              const agent = allUsers.find(u => u.id === l.assignedTo);
              l.assignedName = agent ? (agent.name || agent.email) : 'Unassigned';
              
              if(!l.state && l.city && l.city.includes(',')) {
                 let parts = l.city.split(',');
                 l.stateExtracted = parts[parts.length-1].trim();
                 l.cityClean = parts[0].trim();
              } else {
                 l.stateExtracted = l.state || '';
                 l.cityClean = l.city || '';
              }
              allLeads.push(l);
          });
          populateLeadFilterOptions();
          applyFilters();
      });
  }

  function populateLeadFilterOptions() {
      const build = (key, elId, isAssign=false) => {
          const counts = {};
          if(isAssign) counts['unassigned'] = 0;
          
          allLeads.forEach(l => {
              if(isAssign) {
                  if(!l.assignedTo) counts['unassigned']++;
                  else counts[l.assignedTo] = (counts[l.assignedTo] || 0) + 1;
              } else {
                  const val = l[key] || 'Unknown';
                  counts[val] = (counts[val] || 0) + 1;
              }
          });

          const el = document.getElementById(elId);
          const current = el.value;
          let html = '<option value="">All</option>';
          
          if(isAssign) {
              html += `<option value="unassigned">Unassigned (${counts['unassigned']})</option>`;
              allUsers.filter(u => u.role === 'agent').forEach(u => {
                  html += `<option value="${u.id}">${u.name || u.email} (${counts[u.id] || 0})</option>`;
              });
          } else {
              Object.keys(counts).sort().forEach(k => {
                  if(k) html += `<option value="${k}">${k} (${counts[k]})</option>`;
              });
          }
          el.innerHTML = html;
          el.value = current || (isAssign && current === '' ? 'unassigned' : '');
          if(isAssign && current === 'unassigned') el.value = 'unassigned';
      };

      build('stage', 'f_stage');
      build('cityClean', 'f_city');
      build('stateExtracted', 'f_state');
      build('industry', 'f_industry');
      build('assignedTo', 'f_assign', true);
  }

  function applyFilters() {
      const s_stage = document.getElementById('f_stage').value;
      const s_city = document.getElementById('f_city').value;
      const s_state = document.getElementById('f_state').value;
      const s_ind = document.getElementById('f_industry').value;
      const s_assign = document.getElementById('f_assign').value;

      filteredLeads = allLeads.filter(l => {
          if(s_stage && l.stage !== s_stage) return false;
          if(s_city && l.cityClean !== s_city) return false;
          if(s_state && l.stateExtracted !== s_state) return false;
          if(s_ind && (l.industry || 'Unknown') !== s_ind) return false;
          if(s_assign === 'unassigned') { if(l.assignedTo) return false; }
          else if(s_assign && l.assignedTo !== s_assign) return false;
          return true;
      });

      renderTable();
  }

  function resetFilters() {
      document.getElementById('f_stage').value = '';
      document.getElementById('f_city').value = '';
      document.getElementById('f_state').value = '';
      document.getElementById('f_industry').value = '';
      document.getElementById('f_assign').value = 'unassigned';
      applyFilters();
  }

  window.setSort = (key) => { 
      if(sortKey === key) sortDesc = !sortDesc; 
      else { sortKey = key; sortDesc = true; }
      renderTable(); 
  };

  function renderTable() {
      const tbody = document.getElementById('leadList');
      tbody.innerHTML = '';
      document.getElementById('recordCount').textContent = `${filteredLeads.length} records`;
      document.getElementById('selectAll').checked = false;

      filteredLeads.sort((a,b) => {
          let va = a[sortKey] || ''; let vb = b[sortKey] || '';
          if (typeof va === 'string') va = va.toLowerCase();
          if (typeof vb === 'string') vb = vb.toLowerCase();
          if(sortDesc) return va < vb ? 1 : -1;
          return va < vb ? -1 : 1;
      });

      filteredLeads.slice(0, 100).forEach(l => {
          let actions = '';
          if(l.assignedTo) actions += `<button class="btn secondary" style="padding:4px 8px; font-size:11px; margin-right:6px;" onclick="unassignSingle('${l.id}')">Unassign</button>`;
          actions += `<button class="btn danger" style="padding:4px 8px; font-size:11px;" onclick="deleteSingle('${l.id}')">ðŸ—‘</button>`;
          const assignDisplay = l.assignedTo ? l.assignedName : '<span style="color:#b91c1c; font-weight:700;">Unassigned</span>';

          tbody.innerHTML += `
            <tr>
                <td style="text-align:center;"><input type="checkbox" class="lead-check" value="${l.id}"></td>
                <td style="font-weight:600">${l.company || 'Unknown'}</td>
                <td>${l.cityClean}</td>
                <td>${l.stateExtracted}</td>
                <td>${l.industry || '-'}</td>
                <td style="font-size:12px">${assignDisplay}</td>
                <td><span class="badge">${l.stage}</span></td>
                <td style="text-align:right">${actions}</td>
            </tr>`;
      });
  }

  function toggleAll(src) { document.querySelectorAll('.lead-check').forEach(cb => cb.checked = src.checked); }
  function getChecked() { return Array.from(document.querySelectorAll('.lead-check:checked')).map(cb => cb.value); }

  function assignLeads() {
      const uid = document.getElementById('assignUser').value;
      const ids = getChecked();
      if(!uid) return alert('Select Agent');
      if(ids.length===0) return alert('No leads selected');
      
      const batch = db.batch();
      ids.forEach(id => batch.update(db.collection('leads').doc(id), { assignedTo: uid }));
      batch.commit().then(() => alert('Assigned!'));
  }

  function bulkUnassign() {
      const ids = getChecked();
      if(ids.length===0) return alert('No leads selected');
      if(!confirm(`Unassign ${ids.length} leads?`)) return;
      
      const batch = db.batch();
      ids.forEach(id => batch.update(db.collection('leads').doc(id), { assignedTo: null }));
      batch.commit().then(() => alert('Unassigned!'));
  }
  
  function bulkDelete() {
      const ids = getChecked();
      if(ids.length===0) return alert('No leads selected');
      if(!confirm(`DELETE ${ids.length} leads? This cannot be undone.`)) return;
      const batch = db.batch();
      ids.forEach(id => batch.delete(db.collection('leads').doc(id)));
      batch.commit().then(() => alert('Deleted!'));
  }

  function unassignSingle(id) { db.collection('leads').doc(id).update({ assignedTo: null }); }
  function deleteSingle(id) { if(confirm('Delete?')) db.collection('leads').doc(id).delete(); }

  function createUser() {
    const name = document.getElementById('newUserName').value; 
    const email = document.getElementById('newUserEmail').value;
    const password = document.getElementById('newUserPass').value;
    const role = document.getElementById('newUserRole').value;
    if (!email || !password || !name) return alert('Fill all fields');
    
    const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
    secondaryApp.auth().createUserWithEmailAndPassword(email, password)
        .then((cred) => {
            db.collection('users').doc(cred.user.uid).set({ name, email, role, createdAt: new Date() })
            .then(() => { alert('User created!'); secondaryApp.delete(); });
        }).catch(e => { alert(e.message); secondaryApp.delete(); });
  }

  function deleteUser(id) { if(confirm('Remove user?')) db.collection('users').doc(id).delete(); }
function openEditUser(id) {
      const u = allUsers.find(x => x.id === id);
      document.getElementById('editUserId').value = id;
      document.getElementById('editUserNameField').value = u.name || '';
      document.getElementById('editUserEmailField').value = u.email || '';
      document.getElementById('editUserOldEmail').value = u.email || ''; // Store original
      document.getElementById('editUserModal').classList.add('open');
  }

function saveUserEdit() {
      const id = document.getElementById('editUserId').value;
      const name = document.getElementById('editUserNameField').value.trim();
      const newEmail = document.getElementById('editUserEmailField').value.trim();
      const oldEmail = document.getElementById('editUserOldEmail').value.trim();

      if (!newEmail || !name) return alert('Name and Email are required.');

      const updates = { 
          name: name, 
          email: newEmail,
          updatedAt: new Date()
      };

      // 1. Update the CRM Database (Firestore)
      db.collection('users').doc(id).update(updates).then(() => {
          closeModal('editUserModal');
          
          // 2. Handle the Free-Plan Auth Constraint
          if (newEmail !== oldEmail) {
              alert(
                `STEP 1 COMPLETE: CRM Profile updated to ${newEmail}.\n\n` +
                `STEP 2 REQUIRED (Free Plan Constraint):\n` +
                `Because we are on the Firebase Free tier, you must manually update their login credential.\n\n` +
                `Please go to:\nFirebase Console -> Authentication -> Users -> Edit User, and change their email there.`
              );
          } else {
              alert('User profile updated successfully.');
          }
          
          // Refresh UI locally
          const userIndex = allUsers.findIndex(u => u.id === id);
          if(userIndex > -1) {
              allUsers[userIndex].name = name;
              allUsers[userIndex].email = newEmail;
              renderUsers();
          }
          
      }).catch(e => {
          console.error(e);
          alert("Error updating user: " + e.message);
      });
  }
  async function fetchHistory() {
      const tbody = document.getElementById('historyBody');
      const callerSelect = document.getElementById('h_caller');
      
      tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading History...</td></tr>';
      
      const year = parseInt(document.getElementById('h_year').value);
      const month = parseInt(document.getElementById('h_month').value);
      const day = parseInt(document.getElementById('h_day').value);
      
      const start = new Date(year, month, day);
      const end = new Date(year, month, day, 23, 59, 59);

      let query = db.collectionGroup('activities')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end);

      try {
          const snap = await query.get();
          const allLogs = [];
          const counts = {};

          snap.forEach(doc => { 
              let d = doc.data(); 
              d._leadId = doc.ref.parent.parent.id; 
              allLogs.push(d); 

              const uid = d.createdBy;
              counts[uid] = (counts[uid] || 0) + 1;
          });

          Array.from(callerSelect.options).forEach(opt => {
              if (opt.value === 'all') {
                  opt.text = `All Agents (${allLogs.length})`;
                  return;
              }
              let baseName = opt.text;
              if (userMap[opt.value]) {
                  baseName = userMap[opt.value].name || userMap[opt.value].email;
              } else if (opt.text.includes('(')) {
                  baseName = opt.text.split(' (')[0];
              }

              const count = counts[opt.value] || 0;
              opt.text = `${baseName} (${count})`;
          });

          const selectedCaller = callerSelect.value;
          let displayLogs = allLogs;

          if (selectedCaller !== 'all') {
              displayLogs = allLogs.filter(log => log.createdBy === selectedCaller);
          }

          displayLogs.sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());
          
          if(displayLogs.length === 0) {
              return tbody.innerHTML = '<tr><td colspan="5" style="padding:20px; text-align:center">No activity found for this selection.</td></tr>';
          }
          
          tbody.innerHTML = displayLogs.map(log => {
              const d = log.createdAt.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
              const agent = userMap[log.createdBy] ? (userMap[log.createdBy].name || 'Unknown') : 'Unknown';
              const l = allLeads.find(x => x.id === log._leadId);
              const lName = l ? l.company : 'ID: ' + log._leadId.substr(0,5);
              return `<tr>
                  <td style="font-family:monospace; color:var(--muted)">${d}</td>
                  <td style="font-weight:600">${agent}</td>
                  <td style="color:var(--brand)">${lName}</td>
                  <td><span class="status-pill" style="background:#f1f5f9; color:var(--ink)">${log.action}</span></td>
                  <td style="color:var(--muted)">${log.text||''}</td>
              </tr>`;
          }).join('');

      } catch(e) { 
          console.error(e); 
          tbody.innerHTML = `<tr><td colspan="5" style="color:red">Error: ${e.message}</td></tr>`; 
      }
  }

  function openImportModal() { document.getElementById('importModal').classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  function processImport() {
      const txt = document.getElementById('importText').value;
      if(!txt.trim()) return alert('Paste CSV');
      const lines = txt.trim().split(/\r?\n/);
      const headers = lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/"/g,''));
      
      const batch = db.batch();
      let count = 0;
      for(let i=1; i<lines.length; i++) {
          const row = lines[i].split(',').map(c=>c.trim().replace(/^"|"$/g,''));
          if(row.length < 2) continue;
          const get = (k) => { const idx = headers.findIndex(h=>h.includes(k)); return idx>-1?row[idx]:''; };
          
          const ref = db.collection('leads').doc();
          batch.set(ref, {
              company: get('company')||'Unknown', phone: get('phone'), city: get('city'), industry: get('industry'),
              stage: 'New Lead', nextAction: 'Call Attempt', assignedTo: null, createdAt: new Date()
          });
          count++;
      }
      batch.commit().then(() => { alert(`Imported ${count}`); closeModal('importModal'); });
  }

  function logout() { auth.signOut().then(() => window.location.href = 'index.html'); }
  init();

  // Add this to the script section of admin.html
function sendPasswordReset(email) {
    if(!confirm(`Send password reset email to ${email}?`)) return;
    
    auth.sendPasswordResetEmail(email)
        .then(() => {
            alert(`Password reset email successfully sent to ${email}`);
        })
        .catch((error) => {
            console.error("Error sending reset email:", error);
            alert(`Error: ${error.message}`);
        });
}

// --- EXPORT FEATURE: Leads + History ---
async function exportAllData() {
    if (allLeads.length === 0) return alert("No leads data loaded yet. Please wait.");
    
    const btn = document.querySelector('button[onclick="exportAllData()"]');
    const originalText = btn.innerText;
    btn.innerText = "â³ Generating CSVs...";
    btn.disabled = true;

    try {
        // Helper to clean strings for CSV (removes line breaks, escapes quotes)
        const cleanCSV = (str) => (str || "").toString().replace(/"/g, '""').replace(/\n/g, ' ');

        // 1. GENERATE LEADS CSV (Now includes GBP 1-3 & Recommendation)
        const leadHeaders = [
            "Lead ID", "Company", "City", "State", "Industry", "Phone", "Email", 
            "Stage", "Next Action", "Assigned Agent", 
            "GBP 1", "GBP 2", "GBP 3", "Recommendation", 
            "Initial Notes", "Created At"
        ];
        let leadsCsv = leadHeaders.join(",") + "\n";

        allLeads.forEach(l => {
            const dateStr = l.createdAt && l.createdAt.toDate ? l.createdAt.toDate().toISOString() : "";
            
            // Checking for both exact and camelCase keys just in case the CSV import saved them differently
            const gbp1 = l.gbp1 || l['GBP 1'] || l['GBP 1 (Relevance)'] || "";
            const gbp2 = l.gbp2 || l['GBP 2'] || l['GBP 2 (Conversion)'] || "";
            const gbp3 = l.gbp3 || l['GBP 3'] || l['GBP 3 (Systems)'] || "";
            const rec  = l.recommendation || l['Recommendation'] || "";
            
            const row = [
                l.id,
                `"${cleanCSV(l.company)}"`,
                `"${cleanCSV(l.cityClean)}"`,
                `"${cleanCSV(l.stateExtracted)}"`,
                `"${cleanCSV(l.industry)}"`,
                `"${cleanCSV(l.phone)}"`,
                `"${cleanCSV(l.email)}"`,
                `"${cleanCSV(l.stage)}"`,
                `"${cleanCSV(l.nextAction)}"`,
                `"${cleanCSV(l.assignedName || 'Unassigned')}"`,
                `"${cleanCSV(gbp1)}"`,
                `"${cleanCSV(gbp2)}"`,
                `"${cleanCSV(gbp3)}"`,
                `"${cleanCSV(rec)}"`,
                `"${cleanCSV(l.notes)}"`,
                `"${dateStr}"`
            ];
            leadsCsv += row.join(",") + "\n";
        });

        // 2. GENERATE HISTORY/NOTES CSV (Querying the Collection Group)
        const historyHeaders = ["Lead ID", "Company Name", "Agent", "Action", "Call Notes/Outcome", "Timestamp"];
        let historyCsv = historyHeaders.join(",") + "\n";

        // Fetch all activities globally
        const snap = await db.collectionGroup('activities').get();
        snap.forEach(doc => {
            const d = doc.data();
            const parentLeadId = doc.ref.parent.parent.id;
            const parentLead = allLeads.find(x => x.id === parentLeadId);
            const compName = parentLead ? parentLead.company : "Unknown";
            const agentName = userMap[d.createdBy] ? userMap[d.createdBy].name || userMap[d.createdBy].email : "Unknown";
            const timeStr = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : "";
            
            const combinedNotes = `${d.text || ''} ${d.details || ''}`.trim();

            const row = [
                parentLeadId,
                `"${cleanCSV(compName)}"`,
                `"${cleanCSV(agentName)}"`,
                `"${cleanCSV(d.action)}"`,
                `"${cleanCSV(combinedNotes)}"`,
                `"${timeStr}"`
            ];
            historyCsv += row.join(",") + "\n";
        });

        // 3. TRIGGER DOWNLOADS
        downloadCSV(leadsCsv, `IMPACTA_Leads_Export_${new Date().toISOString().split('T')[0]}.csv`);
        downloadCSV(historyCsv, `IMPACTA_History_Export_${new Date().toISOString().split('T')[0]}.csv`);

    } catch (error) {
        console.error("Export failed:", error);
        alert("Export failed. Check console for details.");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

// Helper function to trigger browser download
function downloadCSV(csvContent, filename) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
</body>
</html>
